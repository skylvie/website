---
import "../styles/global.css";

export interface Props {
    title?: string;
    description?: string;
    ogImage?: string;
}

const {
    title = "",
    description = "HS junior interested in web development and anything network-related",
    ogImage = "https://skylvi.net/pfp.png",
} = Astro.props as Props;
const pageTitle = title ? `${title} | SylvNET` : "SylvNET";
const origin = Astro.url?.origin ?? "http://localhost:4321";
const canonical = `${origin}${Astro.url.pathname}`;

let commitHash = "dev";

try {
    const { execSync } = await import("child_process");
    commitHash = execSync("git rev-parse --short HEAD").toString().trim();
} catch {
    commitHash = "unknown";
}

const commitUrl = `https://github.com/skylvie/website/commit/${commitHash}`;
---

<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>{pageTitle}</title>
        <meta name="description" content={description} />
        <link rel="icon" type="image/png" href="/pfp.png" />
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap"
            rel="stylesheet"
        />
        <meta property="og:title" content={pageTitle} />
        <meta property="og:description" content={description} />
        <meta property="og:type" content="website" />
        <meta property="og:url" content={canonical} />
        <meta property="og:image" content={ogImage} />
        <meta name="theme-color" content="#f5c2e7" />
        <meta name="twitter:card" content="summary" />
        <meta name="twitter:title" content={pageTitle} />
        <meta name="twitter:description" content={description} />
        <meta name="twitter:image" content={ogImage} />
    </head>
    <body>
        <div class="page-shell">
            <header
                class="glass card"
                style="
                    margin-bottom: 18px; 
                    padding: 12px 16px; 
                    display: flex; 
                    align-items: center; 
                    justify-content: space-between; 
                    gap: 12px; 
                    flex-wrap: wrap;
                "
            >
                <nav
                    style="
                        display: flex; 
                        gap: 8px; 
                        font-size: 14px; 
                        flex: 1; 
                        min-width: 0;
                    "
                >
                    <a
                        href="/"
                        class="chip"
                        style="
                            padding: 6px 10px; 
                            font-size: 12px;
                        "
                        >Home</a
                    >
                    <a
                        href="/projects"
                        class="chip"
                        style="
                            padding: 6px 10px; 
                            font-size: 12px;
                        "
                        >Projects</a
                    >
                    <a
                        href="/blog"
                        class="chip"
                        style="
                            padding: 6px 10px; 
                            font-size: 12px;
                        "
                        >Blog</a
                    >
                </nav>
            </header>
            <main>
                <slot />
            </main>
            <footer
                class="glass card"
                style="
                    margin-top: 18px; 
                    padding: 12px 16px; 
                    display: flex; 
                    align-items: center; 
                    justify-content: space-between; 
                    gap: 12px; 
                    flex-wrap: wrap;
                "
            >
                <span
                    id="visitor-count"
                    style="
                        color: var(--muted);
                        font-size: 12px;
                    "
                >
                    Loading visitors...
                </span>
                <a
                    href={commitUrl}
                    target="_blank"
                    rel="noreferrer"
                    style="
                        color: var(--muted);
                        font-size: 12px;
                        font-family: var(--font-mono);
                        text-decoration: underline;
                        transition: color 150ms ease;
                    "
                    title="View commit on GitHub"
                >
                    {commitHash}
                </a>
            </footer>
        </div>
        <script>
            function getOrdinalSuffix(num: number): string {
                const j = num % 10;
                const k = num % 100;
                if (j === 1 && k !== 11) return "st";
                if (j === 2 && k !== 12) return "nd";
                if (j === 3 && k !== 13) return "rd";
                return "th";
            }

            async function loadVisitorCount() {
                try {
                    const res = await fetch("/api/visitor");

                    if (res.ok) {
                        const data = await res.json();
                        const count = data.count;
                        const ordinal = `${count.toLocaleString()}${getOrdinalSuffix(count)}`;
                        const elem = document.getElementById("visitor-count");

                        if (elem) {
                            elem.textContent = `You are the ${ordinal} visitor!`;
                        }
                    }
                } catch (err) {
                    console.error("Failed to load visitor count:", err);
                }
            }

            loadVisitorCount();
        </script>
    </body>
</html>
