---
export const prerender = false;

import BaseLayout from "../layouts/Base.astro";
import projects from "../content/projects.json";

interface RepoCard {
    repoUrl: string;
    liveUrl?: string;
    data: any | null;
}

const items = (projects as any).projects ?? [];

async function loadRepo(repoUrl: string): Promise<any | null> {
    const apiUrl = new URL("/api/github", Astro.url);
    apiUrl.searchParams.set("repo", repoUrl);

    try {
        const res = await fetch(apiUrl);
        return res.ok ? await res.json() : null;
    } catch {
        return null;
    }
}

const repos: RepoCard[] = await Promise.all(
    items.map(async (item: { repo: string; link?: string }) => ({
        repoUrl: item.repo,
        liveUrl: item.link,
        data: await loadRepo(item.repo),
    })),
);
---

<BaseLayout
    title="Projects"
    description="A collection of my projects and repositories"
>
    <section
        class="glass card"
        style="
            display: grid; 
            gap: 14px;
        "
    >
        <h1
            class="section-title"
            style="margin: 0;"
        >
            Projects
        </h1>
        <div
            style="
                display: grid; 
                gap: 12px;
            "
        >
            {
                repos.map((entry) => {
                    const repo = entry.data;
                    const display = repo?.repo ?? entry.repoUrl;
                    return (
                        <article
                            class="glass card"
                            style="
                                display: grid; 
                                gap: 10px;
                            "
                        >
                            <div
                                style="
                                    display: flex; 
                                    justify-content: space-between; 
                                    gap: 10px; 
                                    flex-wrap: wrap; 
                                    align-items: center;
                                "
                            >
                                <a
                                    href={repo?.url ?? entry.repoUrl}
                                    target="_blank"
                                    rel="noreferrer"
                                    style="
                                        font-weight: 700; 
                                        letter-spacing: 0.3px;
                                    "
                                >
                                    {display}
                                </a>
                                {entry.liveUrl ? (
                                    <a
                                        class="button-link"
                                        href={entry.liveUrl}
                                        target="_blank"
                                        rel="noreferrer"
                                    >
                                        Visit
                                    </a>
                                ) : null}
                            </div>
                            <p
                                class="subtle-text"
                                style="
                                    margin: 0; 
                                    color: var(--text);
                                "
                            >
                                {repo?.description ??
                                    "Descriptions will appear once GH loads"}
                            </p>
                            {repo && (
                                <div
                                    style="
                                        display: flex;
                                        align-items: center;
                                        gap: 12px;
                                        font-size: 12px;
                                        color: var(--muted);
                                    "
                                >
                                    {repo.language && (
                                        <span
                                            style="
                                                display: flex;
                                                align-items: center;
                                                gap: 4px;
                                            "
                                        >
                                            <span
                                                style="
                                                    width: 8px;
                                                    height: 8px;
                                                    border-radius: 50%;
                                                    background: var(--accent);
                                                "
                                            />
                                            {repo.language}
                                        </span>
                                    )}
                                    <span
                                        style="
                                            display: flex;
                                            align-items: center;
                                            gap: 4px;
                                        "
                                    >
                                        <svg
                                            width="14"
                                            height="14"
                                            viewBox="0 0 16 16"
                                            fill="currentColor"
                                        >
                                            <path d="M8 .25a.75.75 0 0 1 .673.418l1.882 3.815 4.21.612a.75.75 0 0 1 .416 1.279l-3.046 2.97.719 4.192a.751.751 0 0 1-1.088.791L8 12.347l-3.766 1.98a.75.75 0 0 1-1.088-.79l.72-4.194L.818 6.374a.75.75 0 0 1 .416-1.28l4.21-.611L7.327.668A.75.75 0 0 1 8 .25Zm0 2.445L6.615 5.5a.75.75 0 0 1-.564.41l-3.097.45 2.24 2.184a.75.75 0 0 1 .216.664l-.528 3.084 2.769-1.456a.75.75 0 0 1 .698 0l2.77 1.456-.53-3.084a.75.75 0 0 1 .216-.664l2.24-2.183-3.096-.45a.75.75 0 0 1-.564-.41L8 2.694Z" />
                                        </svg>
                                        {repo.stars ?? 0}
                                    </span>
                                    <span
                                        style="
                                            display: flex;
                                            align-items: center;
                                            gap: 4px;
                                        "
                                    >
                                        <svg
                                            width="14"
                                            height="14"
                                            viewBox="0 0 16 16"
                                            fill="currentColor"
                                        >
                                            <path d="M5 5.372v.878c0 .414.336.75.75.75h4.5a.75.75 0 0 0 .75-.75v-.878a2.25 2.25 0 1 1 1.5 0v.878a2.25 2.25 0 0 1-2.25 2.25h-1.5v2.128a2.251 2.251 0 1 1-1.5 0V8.5h-1.5A2.25 2.25 0 0 1 3.5 6.25v-.878a2.25 2.25 0 1 1 1.5 0ZM5 3.25a.75.75 0 1 0-1.5 0 .75.75 0 0 0 1.5 0Zm6.75.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Zm-3 8.75a.75.75 0 1 0-1.5 0 .75.75 0 0 0 1.5 0Z" />
                                        </svg>
                                        {repo.forks ?? 0}
                                    </span>
                                </div>
                            )}
                        </article>
                    );
                })
            }
        </div>
    </section>
</BaseLayout>
